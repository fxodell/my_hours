# Project Context

## Overview

MyHours is a mobile-first employee timesheet system that replaces spreadsheet-based payroll tracking with role-based web workflows and exportable reports.

Current implementation includes:
- Employee time and PTO entry by pay period
- Timesheet workflow: `draft -> submitted -> approved/rejected`, with manager/admin reopen
- Role-based access controls for employee, manager, and admin use cases
- Manager reporting exports (payroll, billing, hours by employee, hours by job code)
- Staggered bi-weekly pay period groups (A/B)
- Password change + password reset request/reset flows

## Current Architecture

### Backend
- **Framework:** FastAPI (Python 3.12)
- **Data layer:** SQLAlchemy 2.x + Alembic
- **Database:** PostgreSQL in runtime environments
- **AuthN/AuthZ:** JWT bearer token auth, role checks via dependency injection
- **API base path:** `/api/*`
- **Docs/OpenAPI:** `/api/docs`, `/api/redoc`, `/api/openapi.json`
- **Health endpoint:** `/api/health`

### Frontend
- **Framework:** React 18 + TypeScript + Vite
- **State/data:** TanStack Query + React Context + React Hook Form
- **Styling:** Tailwind CSS
- **PWA:** `vite-plugin-pwa` with runtime caching for API/font assets
- **Route guards:** `ProtectedRoute`, `ManagerRoute`, `AdminRoute`

### Database Engine Pattern

The backend uses two SQLAlchemy engines from `backend/app/core/database.py`:
- **Async engine (`asyncpg`)** for request handling via `get_db()`
- **Sync engine (`psycopg2`)** for migrations/scripts

### Runtime and Deployment Options
- Local development through `make` targets (`dev`, `dev-frontend`, `dev-all`)
- Local Docker Compose stack (`db`, `backend`, `frontend`)
- Production deployment details are partially documented in project guidance and should be consolidated over time

## Key Directories

- `backend/app/main.py` - FastAPI app configuration and router registration
- `backend/app/api/` - Route handlers (`auth`, `timesheets`, `reports`, admin CRUD)
- `backend/app/api/deps.py` - Auth and role dependency aliases (`CurrentUser`, `CurrentManager`, `CurrentAdmin`)
- `backend/app/models/` - SQLAlchemy models + mixins
- `backend/app/schemas/` - Pydantic schemas
- `backend/scripts/seed_data.py` - Seed reference data + initial admin
- `backend/scripts/import_locations.py` - Location/job-code import utility
- `frontend/src/App.tsx` - Frontend route map and access guards
- `frontend/src/pages/` - User, manager, and admin page components
- `frontend/src/services/api.ts` - Frontend API wrapper and auth token handling

## Core Domain Workflow

Timesheet lifecycle:
1. Employee creates/edits a timesheet in `draft` (or edits after `rejected`)
2. Employee submits timesheet (`submitted`)
3. Manager/admin approves (`approved`) or rejects (`rejected`) with reason
4. Manager/admin may reopen submitted/approved timesheets back to `draft`

Time and PTO entry editability:
- `draft` and `rejected` timesheets are editable (add/update/delete entries)
- `submitted` and `approved` timesheets are read-only in the employee UI; edit/add/delete controls are hidden and a status-specific banner is shown
- Both time entry and PTO entry dates can be entered for any day within the active pay period bounds (past dates included), while dates outside the pay period are rejected by backend validation
- Adding a time or PTO entry to a `rejected` timesheet auto-resets it to `draft`
- Frontend entry forms (`TimeEntry.tsx`, `PTOEntry.tsx`) accept a `?timesheet=<id>` query parameter to target a specific timesheet; `TimesheetDetail.tsx` passes this when linking to "Add Time" / "Add PTO"
- Shared editability helpers in `frontend/src/timesheetStatus.ts`: `isTimesheetEditable()`, `isTimesheetReadOnly()`, `getEntryDateMax()`
- The `bonus_eligible` time-entry field has been removed from UI and API payloads; database schema no longer stores per-entry bonus eligibility

Access model:
- **Employee:** own timesheets and entries
- **Manager:** approvals, reports, broader timesheet visibility
- **Admin:** manager capabilities plus employee/client/service/location/pay-period administration

Pay period model:
- Employees are assigned to Group A or Group B
- Pay periods are generated by group on alternating two-week cycles

## Development Setup (Current)

1. Install prerequisites: Python 3.12+, Node.js 20+, Docker
2. Start database: `make db-start`
3. Install backend deps: `make install`
4. Install frontend deps: `make install-frontend`
5. Apply migrations: `make migrate`
6. Seed baseline data: `make seed`
7. Run backend API: `make dev` (port `8000`)
8. Run frontend app: `make dev-frontend` (port `3000`)

## Testing State

- Backend tests currently run against in-memory SQLite (`backend/tests/conftest.py`)
- Test coverage includes: auth, health, time entry CRUD (past-day, out-of-period, post-submit blocking), PTO entry CRUD (date validation, post-submit blocking)
- Known issue: session-scoped engine with committed fixtures causes unique constraint failures when running multiple test files together; run individual test files or functions in isolation

## Known Gaps / Follow-ups

- Frontend dev proxy is currently configured for backend port `8002`; default backend `make dev` runs on `8000`
- Docker backend healthcheck currently points to `/health`; app health route is `/api/health`
- Email notifications are currently logged in development mode rather than sent through an SMTP/provider integration
